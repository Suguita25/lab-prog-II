<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Minha Coleção • Pokémon</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { --bg:#f5f6f8; --card:#ffffff; --fg:#111; --muted:#666; --accent:#2563eb; }
    * { box-sizing: border-box; }
    body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; background:var(--bg); color:var(--fg); }
    .wrap { max-width: 1000px; margin: 32px auto; padding: 0 16px; }
    .card { background:var(--card); border-radius:18px; padding:22px; box-shadow: 0 10px 20px rgba(0,0,0,.06); }
    h1,h2 { margin: 0 0 12px; }
    .row { display:flex; gap:10px; margin:10px 0; flex-wrap:wrap; }
    input[type="text"], input[type="number"], input[type="file"] {
      padding:12px 12px; border:1px solid #ddd; border-radius:10px; min-width: 200px; outline:none;
    }
    button { padding:12px 16px; border-radius:10px; border:1px solid #ddd; background:#eee; cursor:pointer; }
    button.primary { background:var(--accent); color:#fff; border-color:transparent; }
    ul { padding-left:18px; }
    .header { display:flex; align-items:center; justify-content:space-between; margin-bottom:18px; }
    .muted { color:var(--muted); font-size:14px; }
    .pill { padding:6px 10px; border-radius:999px; background:#eef2ff; color:#3730a3; font-weight:600; text-decoration:none; }
    pre { background:#0f172a; color:#d1d5db; padding:14px; border-radius:10px; overflow:auto; }
    .progress { height:10px; border-radius:999px; background:#e5e7eb; overflow:hidden; }
    .bar { height:100%; width:0%; background:var(--accent); transition: width .2s; }
    .grid { display:grid; grid-template-columns: 1fr 1fr; gap:22px; }
    @media (max-width: 900px) { .grid { grid-template-columns: 1fr; } }
    table { width:100%; border-collapse: collapse; }
    th, td { text-align:left; padding:8px; border-bottom:1px solid #f0f0f0; }
    th { border-bottom:1px solid #e8e8e8; }
    .link { color: var(--accent); text-decoration: none; }
    .link:hover { text-decoration: underline; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div class="header">
        <div>
          <h1>Minha Coleção</h1>
          <div class="muted">Bem-vindo, <span id="meEmail" class="pill">...</span></div>
        </div>
        <div class="row">
          <button id="logoutBtn">Sair</button>
        </div>
      </div>

      <div class="grid">
        <section>
          <h2>Minhas Pastas</h2>
          <div class="row">
            <input id="folderName" type="text" placeholder="Nome da pasta" />
            <button class="primary" id="btnCreateFolder">Criar pasta</button>
            <button id="btnReloadFolders">Atualizar</button>
          </div>
          <ul id="foldersList"></ul>
        </section>

        <section>
          <h2>Adicionar carta manualmente</h2>
          <div class="row">
            <input id="folderIdManual" type="number" placeholder="Folder ID" />
            <input id="cardName" type="text" placeholder="Nome da carta/Pokémon" />
            <button class="primary" id="btnAddManual">Adicionar</button>
          </div>

          <h2 style="margin-top:24px;">Scanner (upload de imagem)</h2>
          <div class="row">
            <input id="folderIdScan" type="number" placeholder="Folder ID" />
            <input id="fileScan" type="file" accept="image/*" />
            <button id="btnScan" class="primary">Enviar</button>
          </div>
          <div class="progress" aria-hidden="true"><div id="bar" class="bar"></div></div>
        </section>
      </div>

      <!-- Visualização da pasta selecionada -->
      <h2 style="margin-top:26px;">Conteúdo da pasta</h2>
      <div id="folderHeader" class="muted">Selecione uma pasta para visualizar.</div>

      <!-- >>> TABELA SOMENTE COM 2 COLUNAS <<< -->
      <table style="margin-top:10px;">
        <thead>
          <tr>
            <th>Pokémon</th>
            <th>Imagem</th>
          </tr>
        </thead>
        <tbody id="cardsBody">
          <tr><td colspan="2" class="muted" style="padding:10px;">—</td></tr>
        </tbody>
      </table>

      <div class="row" style="margin-top:10px;">
        <a href="/social.html" class="pill" style="background:#e0e7ff;">Rede social</a>
      </div>

      <h2 style="margin-top:26px;">Saída</h2>
      <pre id="output">{}</pre>
    </div>
  </div>

  <script>
    const out = document.getElementById('output');
    const meEmail = document.getElementById('meEmail');
    const bar = document.getElementById('bar');

    // Helpers -------------------------------------------------
    async function getJson(url) {
      const res = await fetch(url, { credentials: 'same-origin' });
      if (res.status === 401) { location.href = '/'; return; }
      return res.json();
    }
    async function postJson(url, body) {
      const res = await fetch(url, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        credentials: 'same-origin',
        body: JSON.stringify(body)
      });
      if (res.status === 401) { location.href = '/'; return; }
      const text = await res.text();
      try { return { ok: res.ok, json: JSON.parse(text) }; }
      catch { return { ok: res.ok, json: { raw: text } }; }
    }
    function setOut(obj) {
      out.textContent = typeof obj === 'string' ? obj : JSON.stringify(obj, null, 2);
    }

    // Sessão --------------------------------------------------
    async function ensureAuth() {
      try {
        const me = await getJson('/api/auth/me');
        if (!me) return;
        meEmail.textContent = me.email || '(sem e-mail)';
      } catch {
        location.href = '/';
      }
    }

    // Pastas --------------------------------------------------
    async function loadFolders() {
      const arr = await getJson('/api/collections/folders');
      if (!arr) return;
      const ul = document.getElementById('foldersList');
      ul.innerHTML = arr.length
        ? arr.map(f => `
          <li>
            <strong>#${f.id}</strong> — ${f.name}
            <button data-open="${f.id}" style="margin-left:8px;">Ver</button>
            <button data-rename="${f.id}">Renomear</button>
            <button data-delete="${f.id}">Excluir</button>
          </li>`).join('')
        : '<li class="muted">Nenhuma pasta</li>';

      ul.querySelectorAll('button[data-open]').forEach(b => b.onclick = () => openFolder(Number(b.dataset.open)));
      ul.querySelectorAll('button[data-rename]').forEach(b => b.onclick = () => renameFolderPrompt(Number(b.dataset.rename)));
      ul.querySelectorAll('button[data-delete]').forEach(b => b.onclick = () => deleteFolderConfirm(Number(b.dataset.delete)));
      setOut(arr);
    }

    async function renameFolderPrompt(folderId) {
      const newName = prompt('Novo nome da pasta:');
      if (!newName) return;
      const r = await fetch(`/api/collections/folders/${folderId}`, {
        method: 'PATCH',
        headers: { 'Content-Type': 'application/json' },
        credentials: 'same-origin',
        body: JSON.stringify({ name: newName })
      });
      if (!r.ok) { setOut(await r.text()); return; }
      await loadFolders();
      const head = document.getElementById('folderHeader');
      if (head && head.textContent.includes(`#${folderId} —`)) head.textContent = `Pasta #${folderId} — ${newName}`;
    }

    async function deleteFolderConfirm(folderId) {
      if (!confirm('Excluir a pasta e TODAS as cartas dentro?')) return;
      const r = await fetch(`/api/collections/folders/${folderId}`, { method: 'DELETE', credentials: 'same-origin' });
      if (!r.ok && r.status !== 204) { setOut(await r.text()); return; }
      const head = document.getElementById('folderHeader');
      if (head && head.textContent.includes(`#${folderId} —`)) {
        head.textContent = 'Selecione uma pasta para visualizar.';
        document.getElementById('cardsBody').innerHTML =
          `<tr><td colspan="2" class="muted" style="padding:10px;">—</td></tr>`;
        document.getElementById('folderIdManual').value = '';
        document.getElementById('folderIdScan').value = '';
      }
      await loadFolders();
    }

    // Abrir pasta e listar cartas (SÓ 2 COLUNAS)
    async function openFolder(folderId) {
      const r = await getJson(`/api/collections/folders/${folderId}`);
      if (!r) return;

      const head = document.getElementById('folderHeader');
      head.textContent = `Pasta #${r.id} — ${r.name}`;

      document.getElementById('folderIdManual').value = folderId;
      document.getElementById('folderIdScan').value   = folderId;

      const tbody = document.getElementById('cardsBody');
      if (!r.items || r.items.length === 0) {
        tbody.innerHTML = `<tr><td colspan="2" class="muted" style="padding:10px;">Sem cartas nesta pasta.</td></tr>`;
      } else {
        tbody.innerHTML = r.items.map(it => {
          const linkImg = it.imagePath
            ? `<a class="link" href="${it.imagePath}" target="_blank">ver</a>`
            : '—';
          return `<tr>
            <td>${it.pokemonName ?? ''}</td>
            <td>${linkImg}</td>
          </tr>`;
        }).join('');
      }

      setOut(r);
    }

    // Criação de pasta
    async function createFolder() {
      const name = document.getElementById('folderName').value.trim();
      if (!name) { setOut({error:'Informe o nome da pasta'}); return; }
      const r = await postJson('/api/collections/folders', { name });
      if (r) setOut(r.json);
      loadFolders();
    }

    // Cartas --------------------------------------------------
    async function addManual() {
      const folderId = Number(document.getElementById('folderIdManual').value);
      const cardName  = document.getElementById('cardName').value.trim();
      if (!folderId || !cardName) { setOut({error:'Preencha Folder ID e Nome da carta'}); return; }
      const r = await postJson('/api/collections/cards/manual', { folderId, cardName });
      if (r) setOut(r.json ?? r);
      if (folderId) openFolder(folderId);
    }

    async function scanUpload() {
      const folderId = Number(document.getElementById('folderIdScan').value);
      const file = document.getElementById('fileScan').files[0];
      if (!folderId || !file) { setOut({error:'Preencha Folder ID e selecione uma imagem'}); return; }

      return new Promise((resolve, reject) => {
        const fd = new FormData();
        fd.append('folderId', folderId);
        fd.append('file', file);

        const xhr = new XMLHttpRequest();
        xhr.open('POST', '/api/collections/cards/scan', true);
        xhr.withCredentials = true;

        xhr.upload.onprogress = (e) => {
          if (e.lengthComputable) {
            const pct = Math.round((e.loaded / e.total) * 100);
            bar.style.width = pct + '%';
          }
        };
        xhr.onload = () => {
          bar.style.width = '0%';
          if (xhr.status === 401) { location.href = '/'; return; }
          try {
            const json = JSON.parse(xhr.responseText || '{}');
            setOut(json);
            if (folderId) openFolder(folderId);
            resolve(json);
          } catch {
            setOut({ raw: xhr.responseText });
            resolve(xhr.responseText);
          }
        };
        xhr.onerror = () => { bar.style.width = '0%'; reject(new Error('Falha no upload')); };
        xhr.send(fd);
      });
    }

    // Logout --------------------------------------------------
    async function doLogout() {
      await fetch('/api/auth/logout', { method:'POST', credentials:'same-origin' });
      location.href = '/';
    }

    // Listeners ----------------------------------------------
    document.getElementById('btnReloadFolders').onclick = loadFolders;
    document.getElementById('btnCreateFolder').onclick  = createFolder;
    document.getElementById('btnAddManual').onclick     = addManual;
    document.getElementById('btnScan').onclick          = scanUpload;
    document.getElementById('logoutBtn').onclick        = doLogout;

    // Boot ----------------------------------------------------
    (async function init(){
      await ensureAuth();
      await loadFolders();
    })();
  </script>
</body>
</html>
