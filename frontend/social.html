<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Rede Social</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { --bg:#f5f6f8; --card:#fff; --fg:#111; --accent:#2563eb; --muted:#666; }
    body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; background:var(--bg); color:var(--fg); }
    .wrap { max-width: 1000px; margin: 24px auto; padding: 0 16px; }
    .card { background:var(--card); border-radius:16px; padding:18px; box-shadow: 0 8px 18px rgba(0,0,0,.06); }
    h1,h2 { margin: 0 0 12px; }
    .row { display:flex; gap:10px; margin:10px 0; flex-wrap:wrap; }
    input,button { padding:10px 12px; border:1px solid #ddd; border-radius:10px; }
    button { background:#eee; cursor:pointer; }
    button.primary { background:var(--accent); color:#fff; border-color:transparent; }
    .grid { display:grid; grid-template-columns: 280px 1fr; gap:18px; }
    @media (max-width: 860px) { .grid { grid-template-columns: 1fr; } }
    .list { list-style:none; padding:0; margin:0; }
    .list li { padding:8px 10px; border:1px solid #eee; border-radius:8px; margin-bottom:8px; display:flex; justify-content:space-between; align-items:center; }
    .chat { height: 420px; overflow:auto; border:1px solid #eee; border-radius:10px; padding:10px; background:#fafafa; }
    .msg { margin-bottom:10px; }
    .me { text-align:right; }
    .muted { color:var(--muted); font-size: 13px; }
    a { color: var(--accent); text-decoration: none; }
    a:hover { text-decoration: underline; }
  </style>
</head>
<body>

<div class="wrap">
  <div class="card">
    <div class="row" style="justify-content:space-between; align-items:center;">
      <h1>Rede Social</h1>
      <div>
        <a href="/app.html">← Voltar ao app</a>
      </div>
    </div>

    <div class="grid">
      <section>
        <h2>Amigos</h2>
        <div class="row">
          <input id="friendEmail" type="email" placeholder="Email do usuário" />
          <button id="btnRequest" class="primary">Enviar solicitação</button>
        </div>
        <h3>Pendentes</h3>
        <ul id="pending" class="list"></ul>
        <h3>Conectados</h3>
        <ul id="friends" class="list"></ul>
      </section>

      <section>
        <h2>Chat</h2>
        <div class="muted">Selecione um amigo para conversar.</div>
        <div id="chat" class="chat"></div>
        <div class="row">
          <input id="msgText" type="text" placeholder="Escreva sua mensagem" style="flex:1" />
          <input id="msgFile" type="file" accept="image/*" />
          <button id="btnSend" class="primary">Enviar</button>
        </div>
      </section>
    </div>
  </div>
</div>

<script>
let currentFriendId = null;
let pollTimer = null;
let lastIso = null;
let chatMsgs = [];
let seenIds = new Set();
window.meId = undefined;

/* ---------------- helpers HTTP ---------------- */
function escapeHtml(s){ return s.replace(/[&<>"']/g, ch => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[ch])) }

async function getJson(url){
  const r = await fetch(url, { credentials:'same-origin' });
  if (r.status === 401) { location.href = '/'; return; }
  return r.json();
}

async function postJson(url, data){
  const r = await fetch(url, {
    method:'POST',
    headers:{'Content-Type':'application/json'},
    credentials:'same-origin',
    body: JSON.stringify(data)
  });
  if (r.status === 401) { location.href='/'; return; }
  const txt = await r.text();
  let json; try { json = JSON.parse(txt); } catch { json = { raw: txt }; }
  if (!r.ok) { alert(json.error || 'Falha'); return null; }
  return json;
}

async function patch(url){
  const r = await fetch(url, { method:'PATCH', credentials:'same-origin' });
  if (r.status === 401) { location.href='/'; return; }
  const txt = await r.text();
  let json; try { json = JSON.parse(txt); } catch { json = { raw: txt }; }
  if (!r.ok) { alert(json.error || 'Falha'); return null; }
  return json;
}

async function ensureAuth() {
  const res = await fetch('/api/auth/me', { credentials: 'same-origin' });
  if (res.status === 401) {
    // sem sessão -> volta para o login (index)
    location.href = '/';
    return null;
  }
  const me = await res.json();
  window.meId = me?.id;
  return me;
}

// substitui loadMe()
async function loadMe(){
  if (window.meId) return window.meId;
  const me = await ensureAuth();
  return me?.id;
}

/* ---------------- UI chat ---------------- */
function setChat(messages) {
  const box = document.getElementById('chat');
  box.innerHTML = messages.map(m => `
    <div class="msg ${m.mine ? 'me':''}">
      ${m.text ? `<div>${escapeHtml(m.text)}</div>`:''}
      ${m.imagePath ? `<div><a href="${m.imagePath}" target="_blank">[imagem]</a></div>`:''}
      <div class="muted">${new Date(m.createdAt).toLocaleString()}</div>
    </div>
  `).join('');
  box.scrollTop = box.scrollHeight;
}

/* ---------------- listas ---------------- */
async function loadPending(){
  await loadMe();
  const arr = await getJson('/api/social/friends/pending') || [];
  const ul = document.getElementById('pending');
  ul.innerHTML = arr.length ? arr.map(f => `
    <li>
      <span>De: ${f.requesterId} → Você</span>
      <span>
        <button data-accept="${f.id}">Aceitar</button>
        <button data-decline="${f.id}">Recusar</button>
      </span>
    </li>`).join('') : '<li class="muted">Nada pendente</li>';

  ul.querySelectorAll('[data-accept]').forEach(b=>b.onclick=async ()=>{
    const ok = await patch(`/api/social/friends/${b.dataset.accept}/accept`);
    if (ok) { loadPending(); loadFriends(); }
  });
  ul.querySelectorAll('[data-decline]').forEach(b=>b.onclick=async ()=>{
    const ok = await patch(`/api/social/friends/${b.dataset.decline}/decline`);
    if (ok) loadPending();
  });
}

async function loadFriends(){
  // 1) garante que meId está setado e é número
  const meId = Number(await loadMe());
  if (!Number.isFinite(meId)) {
    console.warn('meId indefinido — está logado?');
    document.getElementById('friends').innerHTML =
      '<li class="muted">Não foi possível identificar o usuário logado.</li>';
    return;
  }

  // 2) busca amigos
  const arr = await getJson('/api/social/friends') || [];
  console.log('DEBUG /api/social/friends =>', arr, 'meId=', meId);

  // 3) normaliza ids como números e identifica “o outro”
  const entries = (Array.isArray(arr) ? arr : [])
    .map(f => {
      const requesterId = Number(f.requesterId);
      const addresseeId = Number(f.addresseeId);
      if (requesterId === meId) return { other: addresseeId, raw: f };
      if (addresseeId === meId) return { other: requesterId, raw: f };
      return null; // amizade não envolve este usuário (não deveria acontecer, mas ok)
    })
    .filter(Boolean);

  // 4) renderiza ou mostra motivo
  const ul = document.getElementById('friends');
  if (entries.length === 0) {
    // Se a API trouxe itens mas nenhum casou, geralmente é só tipo/string
    const reason = arr.length
      ? 'Amizades retornaram, mas nenhuma corresponde ao seu id. (tipos?)'
      : 'Sem amigos ainda';
    ul.innerHTML = `<li class="muted">${reason}</li>`;
    return;
  }

  ul.innerHTML = entries.map(e =>
    `<li>
       <span>Amigo: ${e.other}</span>
       <button data-open="${e.other}">Conversar</button>
     </li>`
  ).join('');

  // 5) handlers
  ul.querySelectorAll('[data-open]').forEach(b =>
    b.onclick = () => openChat(Number(b.dataset.open))
  );
}


/* ---------------- chat/polling ---------------- */
async function openChat(friendId){
  currentFriendId = friendId;
  lastIso = null;
  chatMsgs = [];
  seenIds = new Set();

  const hist = await getJson(`/api/social/messages?withUserId=${friendId}`) || [];
  hist.forEach(m => seenIds.add(m.id));
  chatMsgs = hist.map(m => ({ ...m, mine: m.senderId === window.meId }));
  setChat(chatMsgs);

  // se não há histórico, começa a vigiar "a partir de agora"
  lastIso = hist.length ? hist[hist.length - 1].createdAt : new Date().toISOString();

  if (pollTimer) clearInterval(pollTimer);
  pollTimer = setInterval(async () => {
    if (!currentFriendId || !lastIso) return;
    const newer = await getJson(`/api/social/messages?withUserId=${currentFriendId}&since=${encodeURIComponent(lastIso)}`) || [];
    if (newer.length){
      newer.forEach(m => {
        if (!seenIds.has(m.id)) {
          seenIds.add(m.id);
          chatMsgs.push({ ...m, mine: m.senderId === window.meId });
        }
      });
      lastIso = newer[newer.length - 1].createdAt;
      setChat(chatMsgs);
    }
  }, 2000);
}

/* ---------------- handlers ---------------- */
document.getElementById('btnRequest').onclick = async () => {
  const email = document.getElementById('friendEmail').value.trim();
  if (!email) { alert('Informe o email'); return; }
  const res = await postJson('/api/social/friends/request', { email });
  if (res) {
    document.getElementById('friendEmail').value='';
    await loadPending();
    await loadFriends();
    alert('Solicitação enviada (ou já existente).');
  }
};

document.getElementById('btnSend').onclick = async () => {
  if (!currentFriendId) { alert('Escolha um amigo primeiro.'); return; }
  const text = document.getElementById('msgText').value;
  const file = document.getElementById('msgFile').files[0];

  const fd = new FormData();
  fd.append('toUserId', currentFriendId);
  if (text) fd.append('text', text);
  if (file) fd.append('file', file);

  const xhr = new XMLHttpRequest();
  xhr.open('POST','/api/social/messages', true);
  xhr.withCredentials = true;
  xhr.onload = () => {
    // backend pode responder 201 (Created) — tratar os dois
    if (xhr.status===201 || xhr.status===200){
      try{
        const msg = JSON.parse(xhr.responseText);
        if (!seenIds.has(msg.id)) {
          seenIds.add(msg.id);
          chatMsgs.push({ ...msg, mine: true });
          if (!lastIso || msg.createdAt > lastIso) lastIso = msg.createdAt;
          setChat(chatMsgs);
        }
      } catch(e){
        console.error('JSON inválido no envio', e, xhr.responseText);
      }
      document.getElementById('msgText').value='';
      document.getElementById('msgFile').value='';
    } else if (xhr.status===401){
      location.href='/';
    } else {
      try{
        const err = JSON.parse(xhr.responseText);
        alert(err.error || 'Falha ao enviar');
      } catch {
        alert('Falha ao enviar');
      }
    }
  };
  xhr.onerror = () => alert('Erro de rede ao enviar.');
  xhr.send(fd);
};

/* ---------------- boot ---------------- */
(async function boot(){
  const me = await ensureAuth();
  if (!me) return; // será redirecionado
  await loadPending();
  await loadFriends();
})();
</script>
</body>



</html>
